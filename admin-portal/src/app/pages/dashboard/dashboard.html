<div class="dashboard-layout">
    <app-sidebar></app-sidebar>
    <div class="dashboard-content">
        <app-header></app-header>
        <div class="dashboard-main">
            <div class="dashboard-overview-row">
                <h2>Overview</h2>
                <div class="dashboard-ago" (click)="toggleCalendar()" tabindex="0" style="cursor:pointer;">
                    {{ formatDate(dateAgo) }}
                    <div *ngIf="showCalendar" class="dashboard-calendar-container calendar-modal"
                        style="position: absolute; left: 0; top: 100%; z-index: 100;"
                        (click)="$event.stopPropagation()">
                        <div class="dashboard-calendar-header">
                            <button (click)="prevMonth()" class="calendar-nav-btn">&lt;</button>
                            <select [(ngModel)]="calendarMonth" (change)="generateCalendarDays()"
                                class="calendar-month-select">
                                <option *ngFor="let m of monthNames; let i = index" [value]="i">{{ m }}</option>
                            </select>
                            <select [(ngModel)]="calendarYear" (change)="generateCalendarDays()"
                                class="calendar-year-select">
                                <option *ngFor="let y of yearOptions" [value]="y">{{ y }}</option>
                            </select>
                            <button (click)="nextMonth()" class="calendar-nav-btn">&gt;</button>
                        </div>
                        <div class="dashboard-calendar-grid">
                            <div class="calendar-day-label"
                                *ngFor="let day of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']">
                                {{ day }}
                            </div>
                            <div *ngFor="let day of calendarDays" class="calendar-day-cell" [class.empty]="day === 0"
                                [class.selected]="selectedDateAgo === (calendarYear + '-' + ((calendarMonth+1).toString().padStart(2,'0')) + '-' + (day.toString().padStart(2,'0')))"
                                (click)="selectCalendarDay(day)">
                                <span *ngIf="day !== 0">{{ day }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <ion-icon name="caret-forward-outline"></ion-icon>
                <div class="dashboard-now">
                    {{ formatDate(dateNow) }}
                </div>
            </div>
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title members-title">
                            <ion-icon name="people-circle-outline" class="people-circle-outline"></ion-icon>
                            <span class="members-count">{{ memberCount !== null ? memberCount : '—' }} Members</span>
                        </div>
                    </div>
                    <div class="dashboard-card-desc members-desc">Total members</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title vouchers-title">
                            <ion-icon name="ticket-outline" class="ticket-outline"></ion-icon>
                            <span class="vouchers-count">
                                {{ allTimeUsedVoucherCount !== null ? allTimeUsedVoucherCount : '—' }} Vouchers
                            </span>
                        </div>
                    </div>
                    <div class="dashboard-card-desc vouchers-desc">Total redemptions</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title points-title">
                            <ion-icon name="pie-chart-outline" class="pie-chart-outline"></ion-icon>
                            <span class="points-count">
                                {{ totalEarnedPoints !== null ? (totalEarnedPoints | number:'1.0-0') : '—' }} Points
                            </span>
                        </div>
                    </div>
                    <div class="dashboard-card-desc points-desc">Total awarded points</div>
                </div>
            </div>
            <div class="dashboard-summary-first-row">
                <div class="dashboard-card summary-card">
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-title">
                            {{ dateAgo | date:'MMMM yyyy' }} - {{ dateNow | date:'MMMM yyyy' }}
                        </div>
                        <div class="dashboard-card-col-left">
                            <div class="dashboard-bar-breakdown-group">
                                <div class="dashboard-bar-group">
                                    <div class="dashboard-bar-total">
                                        <div class="dashboard-bar-fill"
                                            [ngStyle]="{ height: (barTotalFill * barTotalHeight) + 'px', background: '#b61624' }">
                                        </div>
                                    </div>
                                    <div class="dashboard-bar-counter-total">
                                        {{ voucherBreakdown?.total ?? '—' }}
                                    </div>
                                </div>
                                <div class="dashboard-bar-breakdown-right">
                                    <div class="dashboard-bar-breakdown-label">Vouchers breakdown</div>
                                    <div class="dashboard-bar-label-row">
                                        <div class="dashboard-bar-label">Used</div>
                                        <div class="dashboard-bar-label">Unused</div>
                                    </div>
                                    <div class="dashboard-bar-bars">
                                        <div class="dashboard-bar-group">
                                            <div class="dashboard-bar-used">
                                                <div class="dashboard-bar-fill"
                                                    [ngStyle]="{ height: (barUsedFill * barUsedHeight) + 'px', background: '#b61624' }">
                                                </div>
                                            </div>
                                            <div class="dashboard-bar-counter">
                                                {{ voucherBreakdown?.used ?? '—' }}
                                            </div>
                                        </div>
                                        <div class="dashboard-bar-group">
                                            <div class="dashboard-bar-unused">
                                                <div class="dashboard-bar-fill"
                                                    [ngStyle]="{ height: (barUnusedFill * barUnusedHeight) + 'px', background: '#b61624' }">
                                                </div>
                                            </div>
                                            <div class="dashboard-bar-counter">
                                                {{ voucherBreakdown?.unused ?? '—' }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="dashboard-card-col-right">
                            <div>
                                <div class="dashboard-points-label">Points Redeemers / Members</div>
                                <div class="dashboard-points-outer-container">
                                    <div class="dashboard-points-inner-container">
                                        <span>
                                            {{ pointsRedeemers !== null && memberCount !== null ? pointsRedeemers + ' /
                                            ' + memberCount : '—' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="dashboard-card branches-ranking-card">
                                <div class="dashboard-card-header">
                                    <div class="branches-ranking-title">Top Branches</div>
                                    <div class="branches-ranking-points-label">Points</div>
                                </div>
                                <div class="branches-ranking-list">
                                    <ng-container *ngFor="let branch of topBranches">
                                        <div class="branches-ranking-row">
                                            <div class="branches-ranking-name">{{ branch.branchName }}</div>
                                            <div class="branches-ranking-points">
                                                {{ branch.pointsGiven | number:'1.2-2' }}
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card redemption-card" (click)="showHighestRedemptionModal()"
                    style="cursor:pointer;">
                    <div class="dashboard-card-header">
                        <div class="dashboard-card-title">Highest Redemption Day</div>
                    </div>
                    <div class="circle">
                        <div class="dashboard-card-desc"
                            style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;">
                            <svg width="120" height="120" viewBox="0 0 120 120" style="margin-top:10px;">
                                <!-- Background circle -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#fae6e6" stroke-width="16" />
                                <!-- Foreground arc (yellow) -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#ffe100" stroke-width="16"
                                    [attr.stroke-dasharray]="314"
                                    [attr.stroke-dashoffset]="314 - (highestRedemptionPercent / 100 * 314)"
                                    style="transition:stroke-dashoffset 0.7s;" transform="rotate(-90 60 60)" />
                                <!-- Center percent text -->
                                <text x="60" y="60" text-anchor="middle" fill="#333" font-size="1.2em"
                                    font-family="Inter, sans-serif" dy="-0.3em">
                                    {{ highestRedemptionPercent }}%
                                </text>
                                <!-- Center value text: points given / points redeemed -->
                                <text x="60" y="75" text-anchor="middle" fill="#333" font-size="0.8em"
                                    font-family="Inter, sans-serif">
                                    {{ pointsGiven ?? 0 }} / {{ pointsRedeemed ?? 0 }}
                                </text>
                            </svg>
                            <div style="margin-top:10px;color:#333;font-size:1.1em;">
                                {{ highestRedemptionDay }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card ranking-card">
                    <div class="dashboard-card-header">
                        <div class="ranking-card-title">Top 10 Members</div>
                    </div>
                    <div class="dashboard-ranking-list">
                        <ng-container *ngFor="let member of top10Ranking">
                            <div class="dashboard-ranking-row">
                                <div class="dashboard-ranking-info">
                                    <div class="dashboard-ranking-name">{{ member.fullName }}</div>
                                    <div class="dashboard-ranking-email">{{ member.email }}</div>
                                </div>
                                <div class="dashboard-ranking-points">
                                    {{ member.totalEarnedPoints % 1 === 0
                                    ? (member.totalEarnedPoints | number:'1.0-0')
                                    : (member.totalEarnedPoints | number:'1.2-2') }}
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
            <div class="dashboard-summary-second-row">
                <div class="dashboard-card transactions-card">
                    <div class="dashboard-card-header">
                        <div class="transactions-card-title">Latest Voucher Transactions</div>
                    </div>
                    <div class="dashboard-transactions-table">
                        <div class="dashboard-transactions-header">
                            <div class="dashboard-transactions-col points">Points</div>
                            <div class="dashboard-transactions-col member">Member</div>
                            <div class="dashboard-transactions-col code">Voucher Code</div>
                            <div class="dashboard-transactions-col status">Status</div>
                            <div class="dashboard-transactions-col created">Date Used</div>
                        </div>
                        <ng-container *ngFor="let tx of latestTransactions">
                            <div class="dashboard-transactions-row">
                                <div class="dashboard-transactions-col points">{{ tx.points | number:'1.0-2' }}
                                </div>
                                <div class="dashboard-transactions-col member">{{ tx.member }}</div>
                                <div class="dashboard-transactions-col code">{{ tx.voucherCode }}</div>
                                <div class="dashboard-transactions-col status"></div>
                                <div class="dashboard-transactions-col created">
                                    {{ tx.dateUsed | date:'d MMM yyyy' }}
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
                <div class="dashboard-card member-card">
                    <div class="dashboard-member-container">
                        <div class="dashboard-member-col dashboard-member-col-left">
                            <div class="dashboard-member-title">New Member</div>
                            <!-- Example content: Replace with your actual chart or value -->
                            <div class="dashboard-member-chart">
                                <svg width="100" height="100" viewBox="0 0 100 100">
                                    <!-- Background arc (light) -->
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="#fae6e6" stroke-width="20"
                                        stroke-dasharray="180 80" stroke-dashoffset="157" />
                                    <!-- Foreground arc (red) -->
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="#b61624" stroke-width="20"
                                        stroke-dasharray="180 80" stroke-dashoffset="157" />
                                    <!-- Center text -->
                                    <text x="50" y="50" text-anchor="middle" fill="#333"
                                        font-family="Inter, sans-serif">{{ newMembersCount !== null ? newMembersCount :
                                        '—' }}</text>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-member-divider"></div>
                        <div class="dashboard-member-col dashboard-member-col-right">
                            <div class="dashboard-member-title-notif">Popular Notifications</div>
                            <div class="popular-notif-card" *ngIf="mostLikedNotification">
                                <div class="popular-notif-info">
                                    <div class="popular-notif-title">{{ mostLikedNotification.title }}</div>
                                    <div class="popular-notif-desc">{{ mostLikedNotification.description }}</div>
                                    <div class="popular-notif-likes">
                                        <ion-icon name="heart" class="popular-notif-heart"></ion-icon>
                                        <span>{{ mostLikedNotification.likeCount }}</span>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="!mostLikedNotification" class="popular-notif-empty">
                                No popular notifications yet.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="highest-redemption-modal" *ngIf="showRedemptionModal">
    <div class="modal-content">
        <div class="modal-title">Who made the highest redemption</div>
        <div class="modal-avatar">
            <img *ngIf="highestRedeemer?.profileImage !== 'No Image Found'"
                [src]="'data:image/png;base64,' + highestRedeemer?.profileImage" alt="Profile"
                style="width:90px;height:90px;border-radius:50%;object-fit:cover;" />
        </div>
        <div class="modal-name">{{ highestRedeemer?.name ?? '—' }}</div>
        <div class="modal-points">Points Redeemed: {{ highestRedeemer?.points | number:'1.2-2' }}</div>
        <div class="modal-location">{{ highestRedeemer?.location ?? '—' }}</div>
        <button class="modal-ok-btn" (click)="closeHighestRedemptionModal()">OK</button>
    </div>
</div>