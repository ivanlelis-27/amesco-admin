<div class="access-mgmt">
    <app-sidebar></app-sidebar>
    <div class="access-content">
        <app-header></app-header>
        <div class="access-tabs-bar" [class.contact-selected]="activeTab === 'contact'">
            <div class="tab" [class.active]="activeTab === 'users'" (click)="setTab('users')">Users</div>
            <div class="tab" [class.active]="activeTab === 'contact'" (click)="setTab('contact')">Contact Us</div>
            <div class="tab records" *ngIf="activeTab === 'users'">Records: {{ users.length }}</div>
        </div>
        <div *ngIf="activeTab === 'users'" class="access-main" [class.edit-scrollable]="tableEditMode">
            <div class="access-card">
                <div class="access-card-header">
                    <div class="access-search-wrapper">
                        <input class="access-search" type="text" placeholder="Search user..." />
                        <div class="access-search-dropdown-btn-container" (click)="toggleRoleDropdown()">
                            <span class="access-search-dropdown-selected">{{ selectedRole }}</span>
                            <ion-icon name="chevron-down-outline"></ion-icon>
                        </div>
                        <div class="access-search-dropdown" *ngIf="showRoleDropdown">
                            <div class="access-search-dropdown-item" *ngFor="let role of roles"
                                (click)="selectRole(role)">
                                {{ role }}
                            </div>
                        </div>
                    </div>
                    <button class="access-btn add" (click)="openAddUserModal()">ADD USER</button>
                    <button class="access-btn edit" (click)="toggleTableEditMode()">EDIT USER</button>
                    <button class="access-btn reset" (click)="openResetPasswordModal()">RESET PASSWORD</button>
                </div>
                <div class="access-card-body">
                    <div class="access-table-header">
                        <div class="access-table-col">USERS</div>
                        <div class="access-table-col">ROLE</div>
                        <div class="access-table-col">BRANCH</div>
                        <div class="access-table-col">EMAIL</div>
                        <div class="access-table-col">
                            {{ tableEditMode ? 'ACTIONS' : 'LAST LOGIN' }}
                        </div>
                    </div>
                    <div *ngFor="let user of filteredUsers; let i = index" class="access-table-row">
                        <ng-container *ngIf="editingUserIndex === i; else viewRow">
                            <div class="access-table-col">
                                <input [(ngModel)]="editUser.firstName" placeholder="First Name"
                                    style="width: 48%; margin-right: 4%;" />
                                <input [(ngModel)]="editUser.lastName" placeholder="Last Name" style="width: 48%;" />
                            </div>
                            <div class="access-table-col">
                                <select [(ngModel)]="editUser.role">
                                    <option *ngFor="let role of roles" [value]="role">{{ role }}</option>
                                </select>
                            </div>
                            <div class="access-table-col" style="position:relative;">
                                <input [(ngModel)]="editUser.branch" (input)="onEditBranchInput($event.target.value)"
                                    (focus)="showEditBranchSuggestions = true" (blur)="hideEditBranchSuggestions()"
                                    placeholder="Branch" style="width:100%;" />
                                <div class="branch-autocomplete-list"
                                    *ngIf="showEditBranchSuggestions && editFilteredBranches.length > 0">
                                    <div class="branch-autocomplete-item" *ngFor="let branch of editFilteredBranches"
                                        (mousedown)="selectEditBranch(branch)">
                                        <span [style.opacity]="branch.branchName === editUser.branch ? 0.5 : 1">{{
                                            branch.branchName }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="access-table-col">
                                <input [(ngModel)]="editUser.email" placeholder="Email" style="width:100%;" />
                            </div>
                            <div class="access-table-col">
                                <button class="add-user-modal-save-btn" (click)="saveEditUser(i)">Save</button>
                                <button class="add-user-modal-cancel-btn" (click)="cancelEditUser()">Cancel</button>
                            </div>
                        </ng-container>
                        <ng-template #viewRow>
                            <div class="access-table-col">{{ user.fullName }}</div>
                            <div class="access-table-col">{{ user.role }}</div>
                            <div class="access-table-col">{{ getBranchName(user.branchID) }}</div>
                            <div class="access-table-col">{{ user.email }}</div>
                            <div class="access-table-col">
                                <button class="access-btn edit" *ngIf="tableEditMode" (click)="startEditUser(i)">
                                    EDIT
                                </button>
                                <span *ngIf="!tableEditMode">
                                    {{ user.lastLogin ? (user.lastLogin | date:'dd/MM/yyyy HH:mm') : '' }}
                                </span>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>
        <div *ngIf="activeTab === 'contact'" class="access-contact-main">
            <app-contact-us></app-contact-us>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="add-user-modal-backdrop" *ngIf="showAddUserModal" (click)="closeAddUserModal()"></div>
<div class="add-user-modal" *ngIf="showAddUserModal">
    <div class="add-user-modal-header">
        <span>Add User</span>
        <button class="add-user-modal-close" (click)="closeAddUserModal()">&times;</button>
    </div>
    <form class="add-user-modal-form" (ngSubmit)="submitAddUser()" autocomplete="off">
        <div class="add-user-modal-row">
            <label for="firstName">First Name</label>
            <input id="firstName" [(ngModel)]="newUser.firstName" name="firstName" required />
        </div>
        <div class="add-user-modal-row">
            <label for="lastName">Last Name</label>
            <input id="lastName" [(ngModel)]="newUser.lastName" name="lastName" required />
        </div>
        <div class="add-user-modal-row">
            <label for="role">Role</label>
            <select id="role" [(ngModel)]="newUser.role" name="role" required>
                <option *ngFor="let role of roles" [value]="role">{{ role }}</option>
            </select>
        </div>
        <div class="add-user-modal-row" style="position:relative;">
            <label for="branch">Branch</label>
            <input id="branch" [(ngModel)]="newUser.branch" name="branch" required
                (input)="onBranchInput($event.target.value)" (focus)="showBranchSuggestions = true"
                (blur)="hideBranchSuggestions()" autocomplete="off" class="branch-autocomplete-input" />
            <div class="branch-autocomplete-list" *ngIf="showBranchSuggestions && filteredBranches.length > 0">
                <div class="branch-autocomplete-item" *ngFor="let branch of filteredBranches"
                    (mousedown)="selectBranch(branch)">
                    <span [style.opacity]="branch.branchName === newUser.branch ? 0.5 : 1">{{ branch.branchName
                        }}</span>
                </div>
            </div>
        </div>
        <div class="add-user-modal-row">
            <label for="email">Email</label>
            <input id="email" type="email" [(ngModel)]="newUser.email" name="email" required />
        </div>
        <div class="add-user-modal-row">
            <label for="password">Password</label>
            <input id="password" type="password" [(ngModel)]="newUser.password" name="password" required />
        </div>
        <div class="add-user-modal-actions">
            <button type="submit" class="add-user-modal-save-btn">Save</button>
            <button type="button" class="add-user-modal-cancel-btn" (click)="closeAddUserModal()">Cancel</button>
        </div>
    </form>
</div>

<!-- Reset Password Modal -->
<div class="reset-password-modal-backdrop" *ngIf="showResetPasswordModal" (click)="closeResetPasswordModal()"></div>
<div class="reset-password-modal" *ngIf="showResetPasswordModal">
    <div class="reset-password-modal-header">
        <span>Reset Password</span>
        <button class="reset-password-modal-close" (click)="closeResetPasswordModal()">&times;</button>
    </div>
    <div class="reset-password-modal-body">
        <div class="reset-password-search-wrapper">
            <input class="reset-password-search" type="text" placeholder="Search user..." [(ngModel)]="resetSearch"
                (input)="onResetUserInput(resetSearch)" (focus)="showResetUserSuggestions = true"
                (blur)="hideResetUserSuggestions()" autocomplete="off" />
            <div class="reset-user-autocomplete-list" *ngIf="showResetUserSuggestions && filteredResetUsers.length > 0">
                <div class="reset-user-autocomplete-item" *ngFor="let user of filteredResetUsers"
                    (mousedown)="selectResetUser(user)">
                    <span [style.opacity]="user.fullName === resetSearch ? 0.5 : 1">{{ user.fullName }}</span>
                </div>
            </div>
        </div>
        <div class="reset-password-modal-actions">
            <button class="add-user-modal-cancel-btn" (click)="closeResetPasswordModal()">Cancel</button>
            <button class="add-user-modal-save-btn" [disabled]="!selectedResetUser" (click)="resetPassword()">Reset
                Password</button>
        </div>
    </div>
</div>